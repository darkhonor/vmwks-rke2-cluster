name: HCL Format Check

on:
  push:
    branches: [ main, master, develop ]
    paths: [ '**/*.hcl', '**/*.pkr.hcl', '**/*.pkrvars.hcl' ]
  pull_request:
    branches: [ main, master, develop ]
    paths: [ '**/*.hcl', '**/*.pkr.hcl', '**/*.pkrvars.hcl' ]

jobs:
  hcl-format:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Packer
      uses: hashicorp/setup-packer@v3
      with:
        packer-version: latest
        
    - name: Check HCL formatting
      run: |
        echo "Checking HCL file formatting..."
        if packer fmt -check .; then
          echo "✓ All HCL files are properly formatted"
        else
          echo "⚠ HCL files are not properly formatted"
          echo "Run 'packer fmt .' to fix formatting issues"
          exit 1
        fi
        
    - name: Validate Packer templates
      run: |
        echo "Validating Packer templates..."
        find . -name "*.pkr.hcl" -exec dirname {} \; | sort -u | while read dir; do
          echo "Validating template in $dir"
          cd "$dir" && packer validate . && cd - > /dev/null
        done